<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.acastamp.backend.mapper.PaymentMapper">

    <resultMap id="PaymentResultMap" type="com.acastamp.backend.domain.payment.Payment">
        <id property="id" column="id"/>
        <result property="academyId" column="academy_id"/>
        <result property="studentId" column="student_id"/>
        <result property="enrollmentId" column="enrollment_id"/>
        <result property="paymentMethodId" column="payment_method_id"/>
        <result property="amount" column="amount"/>
        <result property="paymentDate" column="payment_date"/>
        <result property="billingMonth" column="billing_month"/>
        <result property="status" column="status"/>
        <result property="notes" column="notes"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <resultMap id="ReceiptResultMap" type="com.acastamp.backend.domain.payment.Receipt">
        <id property="id" column="id"/>
        <result property="academyId" column="academy_id"/>
        <result property="paymentId" column="payment_id"/>
        <result property="receiptNumber" column="receipt_number"/>
        <result property="issueDate" column="issue_date"/>
        <result property="recipientName" column="recipient_name"/>
        <result property="amount" column="amount"/>
        <result property="cashReceiptIssued" column="cash_receipt_issued"/>
        <result property="cashReceiptNumber" column="cash_receipt_number"/>
        <result property="pdfPath" column="pdf_path"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <select id="findById" resultMap="PaymentResultMap">
        SELECT * FROM payment WHERE id = #{id}
    </select>

    <select id="findByStudent" resultMap="PaymentResultMap">
        SELECT * FROM payment WHERE student_id = #{studentId} ORDER BY payment_date DESC
    </select>

    <select id="findByStatus" resultMap="PaymentResultMap">
        SELECT * FROM payment WHERE academy_id = #{academyId} AND status = #{status} ORDER BY payment_date DESC
    </select>

    <select id="findOverduePayments" resultMap="PaymentResultMap">
        SELECT * FROM payment WHERE academy_id = #{academyId} AND status = 'OVERDUE' ORDER BY payment_date
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO payment (academy_id, student_id, enrollment_id, payment_method_id, amount, payment_date, billing_month, status, notes)
        VALUES (#{academyId}, #{studentId}, #{enrollmentId}, #{paymentMethodId}, #{amount}, #{paymentDate}, #{billingMonth}, #{status}, #{notes})
    </insert>

    <update id="update">
        UPDATE payment
        SET amount = #{amount},
            payment_date = #{paymentDate},
            billing_month = #{billingMonth},
            status = #{status},
            notes = #{notes},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <update id="updateStatus">
        UPDATE payment SET status = #{status}, updated_at = CURRENT_TIMESTAMP WHERE id = #{id}
    </update>

    <delete id="delete">
        DELETE FROM payment WHERE id = #{id}
    </delete>

    <select id="findReceiptById" resultMap="ReceiptResultMap">
        SELECT * FROM receipt WHERE id = #{id}
    </select>

    <select id="findReceiptByPaymentId" resultMap="ReceiptResultMap">
        SELECT * FROM receipt WHERE payment_id = #{paymentId}
    </select>

    <select id="findReceiptsByAcademy" resultMap="ReceiptResultMap">
        SELECT * FROM receipt WHERE academy_id = #{academyId} ORDER BY issue_date DESC
    </select>

    <insert id="insertReceipt" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO receipt (academy_id, payment_id, receipt_number, issue_date, recipient_name, amount, cash_receipt_issued, cash_receipt_number, pdf_path)
        VALUES (#{academyId}, #{paymentId}, #{receiptNumber}, #{issueDate}, #{recipientName}, #{amount}, #{cashReceiptIssued}, #{cashReceiptNumber}, #{pdfPath})
    </insert>

    <delete id="deleteReceipt">
        DELETE FROM receipt WHERE id = #{id}
    </delete>

</mapper>
