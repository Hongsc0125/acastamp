<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.acastamp.backend.mapper.AttendanceMapper">

    <resultMap id="AttendanceResultMap" type="com.acastamp.backend.domain.attendance.Attendance">
        <id property="id" column="id"/>
        <result property="academyId" column="academy_id"/>
        <result property="studentId" column="student_id"/>
        <result property="enrollmentId" column="enrollment_id"/>
        <result property="attendanceDate" column="attendance_date"/>
        <result property="attendanceTime" column="attendance_time"/>
        <result property="lessonNumber" column="lesson_number"/>
        <result property="type" column="type"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <resultMap id="MakeupLessonResultMap" type="com.acastamp.backend.domain.attendance.MakeupLesson">
        <id property="id" column="id"/>
        <result property="academyId" column="academy_id"/>
        <result property="studentId" column="student_id"/>
        <result property="enrollmentId" column="enrollment_id"/>
        <result property="originalDate" column="original_date"/>
        <result property="makeupDate" column="makeup_date"/>
        <result property="makeupTime" column="makeup_time"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="findById" resultMap="AttendanceResultMap">
        SELECT * FROM attendance WHERE id = #{id}
    </select>

    <select id="findByStudent" resultMap="AttendanceResultMap">
        SELECT * FROM attendance WHERE student_id = #{studentId} ORDER BY attendance_date DESC, attendance_time DESC
    </select>

    <select id="findByEnrollment" resultMap="AttendanceResultMap">
        SELECT * FROM attendance WHERE enrollment_id = #{enrollmentId} ORDER BY attendance_date DESC
    </select>

    <select id="findByDateRange" resultMap="AttendanceResultMap">
        SELECT * FROM attendance
        WHERE academy_id = #{academyId}
          AND attendance_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY attendance_date DESC, attendance_time DESC
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO attendance (academy_id, student_id, enrollment_id, attendance_date, attendance_time, lesson_number, type)
        VALUES (#{academyId}, #{studentId}, #{enrollmentId}, #{attendanceDate}, #{attendanceTime}, #{lessonNumber}, #{type})
    </insert>

    <delete id="delete">
        DELETE FROM attendance WHERE id = #{id}
    </delete>

    <select id="findMakeupById" resultMap="MakeupLessonResultMap">
        SELECT * FROM makeup_lesson WHERE id = #{id}
    </select>

    <select id="findMakeupsByStudent" resultMap="MakeupLessonResultMap">
        SELECT * FROM makeup_lesson WHERE student_id = #{studentId} ORDER BY makeup_date DESC
    </select>

    <select id="findMakeupsByStatus" resultMap="MakeupLessonResultMap">
        SELECT * FROM makeup_lesson WHERE academy_id = #{academyId} AND status = #{status} ORDER BY makeup_date
    </select>

    <insert id="insertMakeup" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO makeup_lesson (academy_id, student_id, enrollment_id, original_date, makeup_date, makeup_time, status)
        VALUES (#{academyId}, #{studentId}, #{enrollmentId}, #{originalDate}, #{makeupDate}, #{makeupTime}, #{status})
    </insert>

    <update id="updateMakeupStatus">
        UPDATE makeup_lesson SET status = #{status}, updated_at = CURRENT_TIMESTAMP WHERE id = #{id}
    </update>

    <delete id="deleteMakeup">
        DELETE FROM makeup_lesson WHERE id = #{id}
    </delete>

</mapper>
